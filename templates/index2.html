<!DOCTYPE html>
<html lang="{{ lang|default('zh') }}">
<head>
  <meta charset="UTF-8">
  <title>æ”¹è‰¯è„‘æ¢—æ­»æº¶æ “(mTICI) è¾…åŠ©è¯Šæ–­ç³»ç»Ÿ| HMI-Med</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #f0f6ff, #ffffff);
      font-family: "Segoe UI", "Microsoft YaHei";
      color: #333;
      min-height: 100vh;
    }

    .main-card {
      max-width: 900px;
      margin: 50px auto;
      padding: 40px;
      border-radius: 16px;
      background: #fff;
      box-shadow: 0 6px 20px rgba(0,0,0,0.08);
      text-align: center;
      transition: all 0.4s ease;
    }

    h2.title { color: #004aad; font-weight: bold; margin-bottom: 10px; }
    p.subtitle { color: #6c757d; margin-bottom: 25px; }

    .preview-container {
      margin-top: 10px;
    }

    .preview-gif {
      max-width: 100%;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .btn-primary {
      background-color: #007bff;
      border: none;
      font-weight: 600;
      padding: 10px 30px;
      border-radius: 8px;
      transition: background-color 0.3s ease;
    }

    .btn-primary:hover {
      background-color: #0056b3;
    }

    .lang-switch {
      display: inline-flex;
      border-radius: 999px;
      background-color: rgba(0, 74, 173, 0.08);
      padding: 4px;
    }

    .lang-switch .btn {
      border-radius: 999px !important;
      font-weight: 600;
    }

    .mtici-info {
      margin-top: 32px;
      text-align: left;
      background: rgba(0, 74, 173, 0.05);
      border-radius: 12px;
      padding: 18px 20px;
      box-shadow: inset 0 0 0 1px rgba(0, 74, 173, 0.08);
    }

    .mtici-info h6 {
      color: #004aad;
      font-weight: 700;
      margin-bottom: 12px;
    }

    .mtici-info p,
    .mtici-info li {
      font-size: 0.9rem;
      color: #495057;
    }
  </style>
</head>
<body>
  <!-- ===== ä¸Šä¼ è¡¨å•å¡ç‰‡ ===== -->
  <div id="uploadCard" class="main-card fade-in">
    <div class="d-flex justify-content-end mb-3">
      <div class="lang-switch btn-group btn-group-sm" role="group" id="langSwitch">
        <button type="button" class="btn btn-outline-primary" data-lang="zh">ä¸­æ–‡</button>
        <button type="button" class="btn btn-outline-primary" data-lang="en">English</button>
      </div>
    </div>
    <h2 class="title" data-i18n="title">ğŸ©» æ”¹è‰¯è„‘æ¢—æ­»æº¶æ “(mTICI) è¾…åŠ©è¯Šæ–­ç³»ç»Ÿ</h2>
    <p class="subtitle" data-i18n="subtitle">ä¸Šä¼ å† çŠ¶ä½ä¸çŸ¢çŠ¶ä½å½±åƒï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è¿›è¡Œç‰¹å¾åˆ†æä¸åˆ†çº§é¢„æµ‹ã€‚</p>

    <form id="uploadForm" action="/" method="post" enctype="multipart/form-data">
      <input type="hidden" name="lang" id="langInput" value="{{ lang|default('zh') }}">
      <div class="upload-box">
        <label class="file-label" data-i18n="corLabel">å† çŠ¶è§†å›¾ (COR) DICOM æ–‡ä»¶</label>
        <input class="form-control" id="corFile" type="file" name="cor_dicom" accept=".dcm" required>
        <div id="corName" class="file-name"></div>
        <div id="corPreviewContainer" class="preview-container d-none">
          <div class="preview-title" data-i18n="previewTitle">å¿«é€Ÿé¢„è§ˆ</div>
          <img id="corPreview" class="preview-gif d-none" alt="COR é¢„è§ˆ" />
          <div id="corPreviewStatus" class="text-muted small mt-2" data-status="idle">ç­‰å¾…ç”Ÿæˆé¢„è§ˆ...</div>
        </div>
      </div>

      <div class="upload-box mt-3">
        <label class="file-label" data-i18n="sagLabel">çŸ¢çŠ¶è§†å›¾ (SAG) DICOM æ–‡ä»¶</label>
        <input class="form-control" id="sagFile" type="file" name="sag_dicom" accept=".dcm" required>
        <div id="sagName" class="file-name"></div>
        <div id="sagPreviewContainer" class="preview-container d-none">
          <div class="preview-title" data-i18n="previewTitle">å¿«é€Ÿé¢„è§ˆ</div>
          <img id="sagPreview" class="preview-gif d-none" alt="SAG é¢„è§ˆ" />
          <div id="sagPreviewStatus" class="text-muted small mt-2" data-status="idle">ç­‰å¾…ç”Ÿæˆé¢„è§ˆ...</div>
        </div>
      </div>

      <button id="submitBtn" class="btn btn-primary mt-3" type="submit" data-i18n="submit">å¼€å§‹é¢„æµ‹</button>
    </form>

    <div class="footer mt-3" data-i18n="footer">
      Â© 2025 HMI-Med Demo | æ™ºèƒ½åŒ»å­¦å½±åƒåˆ†æ
    </div>
  </div>

  <!-- ===== åŠ è½½ç•Œé¢ ===== -->
  <div id="loading" style="display:none;">
    <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;" role="status"></div>
    <h5 class="mt-4" data-i18n="loadingTitle">ç³»ç»Ÿæ­£åœ¨åˆ†æï¼ŒDICOM é¢„è§ˆå¦‚ä¸‹â€¦</h5>
    <div class="loading-gif-wrapper d-flex justify-content-center gap-3 mt-3">
      <div class="loading-gif-card text-center">
        <h6 data-i18n="loadingCorHeading">å† çŠ¶ä½é¢„è§ˆ</h6>
        <img id="loadingCorGif" class="preview-gif d-none" alt="COR GIF é¢„è§ˆ" />
        <div id="loadingCorPlaceholder" class="text-muted small mt-2">ç­‰å¾…ç”Ÿæˆ...</div>
      </div>
      <div class="loading-gif-card text-center">
        <h6 data-i18n="loadingSagHeading">çŸ¢çŠ¶ä½é¢„è§ˆ</h6>
        <img id="loadingSagGif" class="preview-gif d-none" alt="SAG GIF é¢„è§ˆ" />
        <div id="loadingSagPlaceholder" class="text-muted small mt-2">ç­‰å¾…ç”Ÿæˆ...</div>
      </div>
    </div>

    <div class="mtici-info mt-4">
  <h6 data-i18n="mticiHeading">mTICI åˆ†çº§ç®€ä»‹</h6>
  <p class="mb-2" data-i18n="mticiLead">
    æ”¹è‰¯è¡€æ “æº¶æ “åœ¨è„‘è¡€ç®¡ç–¾ç—…è¯„ä¼°ä¸­å¸¸ç”¨ mTICI åˆ†çº§æ¥æè¿°è¡€ç®¡å†é€šæƒ…å†µ[1]ï¼š
  </p>
  <ul class="ps-3 mb-0">
    <li data-i18n="mtici0"><strong>mTICI 0ï¼š</strong>æ— å†é€šï¼Œå®Œå…¨é—­å¡ã€‚</li>
    <li data-i18n="mtici1"><strong>mTICI 1ï¼š</strong>å¾®é‡å†é€šï¼Œé€ å½±å‰‚ä»…å°‘é‡é€šè¿‡ã€‚</li>
    <li data-i18n="mtici2a"><strong>mTICI 2aï¼š</strong>éƒ¨åˆ†å†é€šï¼ŒçŒæ³¨ä¸åˆ° 50%ã€‚</li>
    <li data-i18n="mtici2b"><strong>mTICI 2bï¼š</strong>å¤§éƒ¨åˆ†å†é€šï¼ŒçŒæ³¨ 50-99%ã€‚</li>
    <li data-i18n="mtici3"><strong>mTICI 3ï¼š</strong>å®Œå…¨å†é€šï¼Œæ­£å¸¸çŒæ³¨ã€‚</li>
  </ul>

  <p class="mt-3" data-i18n="mticiNote">
    åœ¨ä¸´åºŠå®è·µä¸­ï¼ŒmTICI è¯„åˆ† T1 çš„å®šä¹‰è¾ƒä¸ºæ¨¡ç³Šï¼Œè§‚å¯Ÿè€…é—´å·®å¼‚è¾ƒå¤§ï¼ŒT0 ä¸ T1
    å¸¸è¢«åˆå¹¶ä¸º T0/1 è¯„åˆ†[2]ã€‚
  </p>

  <p class="small text-muted mt-2 mb-0" data-i18n="mticiRefs">
    [1] Zaidat O O, Yoo A J, Khatri P, et al. <em>Recommendations on angiographic revascularization grading standards for acute ischemic stroke: a consensus statement.</em>
    <strong>Stroke</strong>, 2013, 44(9): 2650â€“2663.  
    <br>
    [2] Tung E L, McTaggart R A, Baird G L, et al. <em>Rethinking thrombolysis in cerebral infarction 2b: which thrombolysis in cerebral infarction scales best define near complete recanalization in the modern thrombectomy era?</em>
    <strong>Stroke</strong>, 2017, 48(9): 2488â€“2493.
  </p>
</div>
  </div>

  <!-- ===== å‰ç«¯äº¤äº’é€»è¾‘ ===== -->
  <script>
    const DEFAULT_FPS = 4;
    const previewState = { cor: null, sag: null };

    // å¤šè¯­è¨€ç¿»è¯‘è¡¨
    const translations = {
      zh: {
        title: "ğŸ©» æ”¹è‰¯è„‘æ¢—æ­»æº¶æ “(mTICI) è¾…åŠ©è¯Šæ–­ç³»ç»Ÿ",
        subtitle: "ä¸Šä¼ å† çŠ¶ä½ä¸çŸ¢çŠ¶ä½å½±åƒï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è¿›è¡Œç‰¹å¾åˆ†æä¸åˆ†çº§é¢„æµ‹ã€‚",
        corLabel: "å† çŠ¶è§†å›¾ (COR) DICOM æ–‡ä»¶",
        sagLabel: "çŸ¢çŠ¶è§†å›¾ (SAG) DICOM æ–‡ä»¶",
        previewTitle: "å¿«é€Ÿé¢„è§ˆ",
        submit: "å¼€å§‹é¢„æµ‹",
        footer: "Â© 2025 HMI-Med Demo | æ™ºèƒ½åŒ»å­¦å½±åƒåˆ†æ",
        loadingTitle: "ç³»ç»Ÿæ­£åœ¨åˆ†æï¼ŒDICOM é¢„è§ˆå¦‚ä¸‹â€¦",
        loadingCorHeading: "å† çŠ¶ä½é¢„è§ˆ",
        loadingSagHeading: "çŸ¢çŠ¶ä½é¢„è§ˆ",
        mticiHeading: "mTICI åˆ†çº§ç®€ä»‹",
        mticiLead: "æ”¹è‰¯è¡€æ “æº¶æ “åœ¨è„‘è¡€ç®¡ç–¾ç—…è¯„ä¼°ä¸­å¸¸ç”¨ mTICI åˆ†çº§æ¥æè¿°è¡€ç®¡å†é€šæƒ…å†µ[1]ï¼š",
        mtici0: "<strong>mTICI 0ï¼š</strong>æ— å†é€šï¼Œå®Œå…¨é—­å¡ã€‚",
        mtici1: "<strong>mTICI 1ï¼š</strong>å¾®é‡å†é€šï¼Œé€ å½±å‰‚ä»…å°‘é‡é€šè¿‡ã€‚",
        mtici2a: "<strong>mTICI 2aï¼š</strong>éƒ¨åˆ†å†é€šï¼ŒçŒæ³¨ä¸åˆ° 50%ã€‚",
        mtici2b: "<strong>mTICI 2bï¼š</strong>å¤§éƒ¨åˆ†å†é€šï¼ŒçŒæ³¨ 50-99%ã€‚",
        mtici3: "<strong>mTICI 3ï¼š</strong>å®Œå…¨å†é€šï¼Œæ­£å¸¸çŒæ³¨ã€‚",
        mticiNote: "<strong>åœ¨ä¸´åºŠå®è·µä¸­ï¼ŒmTICI è¯„åˆ† T1 çš„å®šä¹‰è¾ƒä¸ºæ¨¡ç³Šï¼Œè§‚å¯Ÿè€…é—´å·®å¼‚è¾ƒå¤§ï¼ŒT0 ä¸ T1 å¸¸è¢«åˆå¹¶ä¸º T0/1 è¯„åˆ†[2]ã€‚<strong>",
        mticiRefs: "[1] Zaidat O O, Yoo A J, Khatri P, et al. <em>Recommendations on angiographic revascularization grading standards for acute ischemic stroke: a consensus statement.</em> <strong>Stroke</strong>, 2013, 44(9): 2650â€“2663.<br>[2] Tung E L, McTaggart R A, Baird G L, et al. <em>Rethinking thrombolysis in cerebral infarction 2b: which thrombolysis in cerebral infarction scales best define near complete recanalization in the modern thrombectomy era?</em> <strong>Stroke</strong>, 2017, 48(9): 2488â€“2493."
      },
      en: {
        title: "ğŸ©» mTICI-assisted Stroke Thrombolysis Decision Support",
        subtitle: "Upload coronal and sagittal DICOM studies for automated analysis.",
        corLabel: "Coronal View (COR) DICOM File",
        sagLabel: "Sagittal View (SAG) DICOM File",
        previewTitle: "Quick Preview",
        submit: "Start Prediction",
        footer: "Â© 2025 HMI-Med Demo | Intelligent Medical Imaging",
        loadingTitle: "Analyzingâ€¦ DICOM previews are shown below.",
        loadingCorHeading: "Coronal Preview",
        loadingSagHeading: "Sagittal Preview",
        mticiHeading: "mTICI Grading Overview",
        mticiLead: "The modified TICI scale describes cerebral reperfusion status [1]:",
        mtici0: "<strong>mTICI 0:</strong> No reperfusion; complete occlusion.",
        mtici1: "<strong>mTICI 1:</strong> Minimal reperfusion with limited contrast passage.",
        mtici2a: "<strong>mTICI 2a:</strong> Partial reperfusion with &lt; 50% distal filling.",
        mtici2b: "<strong>mTICI 2b:</strong> Substantial reperfusion with 50â€“99% perfusion.",
        mtici3: "<strong>mTICI 3:</strong> Complete reperfusion with normal distal flow.",
        mticiNote: "<strong>In clinical practice, the definition of T1 is ambiguous, and inter-observer variability is high; T0 and T1 are often merged as T0/1 [2].<strong>",
        mticiRefs: "[1] Zaidat O O, Yoo A J, Khatri P, et al. <em>Recommendations on angiographic revascularization grading standards for acute ischemic stroke: a consensus statement.</em> <strong>Stroke</strong>, 2013, 44(9): 2650â€“2663.<br>[2] Tung E L, McTaggart R A, Baird G L, et al. <em>Rethinking thrombolysis in cerebral infarction 2b: which thrombolysis in cerebral infarction scales best define near complete recanalization in the modern thrombectomy era?</em> <strong>Stroke</strong>, 2017, 48(9): 2488â€“2493."
      }
    };

    const langInput = document.getElementById("langInput");
    const langSwitchButtons = document.querySelectorAll("#langSwitch [data-lang]");
    let currentLang = langInput.value || "zh";

    function applyTranslations() {
      const t = translations[currentLang];
      document.querySelectorAll("[data-i18n]").forEach(el => {
        const key = el.dataset.i18n;
        if (t[key]) el.innerHTML = t[key];
      });
    }

    function setLanguage(lang) {
      currentLang = lang;
      langInput.value = lang;
      document.documentElement.lang = lang;
      localStorage.setItem("mtici-lang", lang);
      applyTranslations();
    }

    langSwitchButtons.forEach(btn => {
      btn.addEventListener("click", () => setLanguage(btn.dataset.lang));
    });

    applyTranslations();

    // æ–‡ä»¶é€‰æ‹©ä¸ GIF é¢„è§ˆ
    async function requestGif(file, key) {
      if (!file) return;
      const formData = new FormData();
      formData.append("dicom", file);

      const previewContainer = document.getElementById(`${key}PreviewContainer`);
      const previewImg = document.getElementById(`${key}Preview`);
      const previewStatus = document.getElementById(`${key}PreviewStatus`);
      previewContainer.classList.remove("d-none");
      previewImg.classList.add("d-none");
      previewStatus.textContent = "æ­£åœ¨ç”Ÿæˆé¢„è§ˆâ€¦";

      try {
        const res = await fetch("/preview_gif", { method: "POST", body: formData });
        const data = await res.json();
        if (!data.gif) throw new Error(data.error || "ç”Ÿæˆ GIF å¤±è´¥");
        previewImg.src = `data:image/gif;base64,${data.gif}`;
        previewImg.classList.remove("d-none");
        previewStatus.textContent = `âœ… é¢„è§ˆç”ŸæˆæˆåŠŸï¼ˆFPS: ${data.fps?.toFixed(2) || 4}ï¼‰`;
        previewState[key] = { src: previewImg.src };
      } catch (err) {
        previewStatus.textContent = "âŒ " + err.message;
      }
    }

    function handleFileSelect(inputId, nameId, key) {
      const input = document.getElementById(inputId);
      const nameBox = document.getElementById(nameId);
      input.addEventListener("change", () => {
        const file = input.files[0];
        if (!file) return;
        if (!file.name.toLowerCase().endsWith(".dcm")) {
          alert("ä»…æ”¯æŒ DICOM (.dcm) æ–‡ä»¶");
          input.value = "";
          return;
        }
        nameBox.innerText = "âœ… " + file.name;
        requestGif(file, key);
      });
    }

    handleFileSelect("corFile", "corName", "cor");
    handleFileSelect("sagFile", "sagName", "sag");

    // æäº¤é€»è¾‘
    const form = document.getElementById("uploadForm");
    form.addEventListener("submit", e => {
      e.preventDefault();
      document.getElementById("uploadCard").classList.add("fade-out");
      setTimeout(() => {
        document.getElementById("uploadCard").style.display = "none";
        const loading = document.getElementById("loading");
        loading.style.display = "block";
        loading.classList.add("fade-in");
        if (previewState.cor?.src) {
          document.getElementById("loadingCorGif").src = previewState.cor.src;
          document.getElementById("loadingCorGif").classList.remove("d-none");
          document.getElementById("loadingCorPlaceholder").classList.add("d-none");
        }
        if (previewState.sag?.src) {
          document.getElementById("loadingSagGif").src = previewState.sag.src;
          document.getElementById("loadingSagGif").classList.remove("d-none");
          document.getElementById("loadingSagPlaceholder").classList.add("d-none");
        }
        form.submit();
      }, 400);
    });
  </script>
</body>
</html>
